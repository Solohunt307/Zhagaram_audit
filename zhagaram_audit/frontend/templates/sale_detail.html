{% extends "base.html" %}
{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Sale Detail & Payment</h2>
        <a href="/sales" class="btn btn-secondary">Back to Sales List</a>
    </div>
    <div id="loading-spinner" class="text-center p-5"><div class="spinner-border text-primary"></div></div>

    <div id="sale-detail-content" class="card shadow p-4" style="display: none;">
        <div class="row mb-4 border-bottom pb-3">
            <div class="col-md-6">
                <h4 id="invoice-number" class="text-primary"></h4>
                <p>Customer: <strong id="customer-name"></strong></p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="text-muted">Date: <span id="sale-date"></span></p>
                <h4><span id="sale-status-badge" class="badge"></span></h4>
            </div>
        </div>

        <div id="action-buttons-area" class="text-center mb-4"></div>

        <table class="table table-bordered table-sm mb-4">
            <thead class="table-light"><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
            <tbody id="items-table-body"></tbody>
        </table>

        <div class="row">
            <div class="col-md-6">
                <h6>Payment History</h6>
                <table class="table table-sm border">
                    <thead class="table-light"><tr><th>Date</th><th>Type</th><th>Amount</th></tr></thead>
                    <tbody id="payments-table-body"></tbody>
                </table>
            </div>
            <div class="col-md-6 bg-light p-3 border rounded">
                <h5 class="text-end">Total: <span id="total-amount" class="fw-bold"></span></h5>
                <h5 class="text-end text-danger">Balance: <span id="balance-due" class="fw-bold"></span></h5>
                
                <div id="payment-form-area" style="display:none;" class="mt-3 p-3 border-top">
                    <h6>Record New Payment</h6>
                    <form id="add-payment-form">
                        <input type="number" step="0.01" class="form-control mb-2" id="payment-amount" required>
                        <select class="form-select mb-2" id="payment-type">
                            <option value="CASH">CASH</option>
                            <option value="CARD">CARD</option>
                        </select>
                        <button type="submit" class="btn btn-primary w-100">Post Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const saleId = '{{ sale_id }}';

        async function loadData() {
            const res = await fetchAPI(`/api/sales/${saleId}`);
            if (res && res.ok) {
                const sale = await res.json();
                
                document.getElementById('invoice-number').innerText = sale.invoice_number || 'No Invoice #';
                document.getElementById('customer-name').innerText = sale.customer.name;
                document.getElementById('sale-date').innerText = sale.date;
                document.getElementById('total-amount').innerText = "Rs. " + safeFixed(sale.total_amount);
                document.getElementById('balance-due').innerText = "Rs. " + safeFixed(sale.balance_due);
                
                const badge = document.getElementById('sale-status-badge');
                badge.innerText = sale.status;
                badge.className = `badge bg-${sale.status === 'PAID' ? 'success' : (sale.status === 'QUOTE' ? 'warning' : 'primary')}`;

                document.getElementById('items-table-body').innerHTML = sale.items.map(i => `
                    <tr><td>${i.product_name}</td><td>${i.quantity}</td><td>${safeFixed(i.unit_price)}</td><td>${safeFixed(i.total)}</td></tr>
                `).join('');

                const payBody = document.getElementById('payments-table-body');
                payBody.innerHTML = sale.payments.length ? sale.payments.map(p => `
                    <tr><td>${p.date}</td><td>${p.payment_type}</td><td>${safeFixed(p.amount)}</td></tr>
                `).join('') : '<tr><td colspan="3" class="text-center text-muted">No payments recorded</td></tr>';

                const balance = parseFloat(sale.balance_due);
                document.getElementById('payment-form-area').style.display = balance > 0.01 ? 'block' : 'none';
                document.getElementById('payment-amount').value = balance.toFixed(2);

                const actionArea = document.getElementById('action-buttons-area');
                actionArea.innerHTML = '';
                if (sale.status === 'QUOTE') {
                    const btn = document.createElement('button');
                    btn.className = "btn btn-success px-4 shadow-sm";
                    btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Convert to Invoice';
                    btn.onclick = async () => {
                        const r = await fetchAPI(`/api/sales/${saleId}/convert`, { method: 'POST' });
                        if(r && r.ok) {
                            showNotification("Converted to Invoice");
                            loadData();
                        }
                    };
                    actionArea.appendChild(btn);
                }
            }
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('sale-detail-content').style.display = 'block';
        }

        document.getElementById('add-payment-form').onsubmit = async (e) => {
            e.preventDefault();
            const amt = document.getElementById('payment-amount').value;
            const type = document.getElementById('payment-type').value;
            const res = await fetchAPI(`/api/sales/${saleId}/payment?amount=${amt}&payment_type=${type}`, {method:'POST'});
            if(res && res.ok) {
                showNotification("Payment recorded!");
                loadData();
            }
        };

        loadData();
    });
</script>
{% endblock %}