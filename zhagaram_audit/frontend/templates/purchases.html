{% extends "base.html" %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h4>Add New Supplier <span id="supplier-id-display" class="badge bg-secondary ms-2" style="display:none;"></span></h4> 
    </div>
    <div class="card-body">
        <form id="add-supplier-form" class="row g-3">
            <input type="hidden" id="supplier-id-field" value=""> 

            <div class="col-md-3">
                <label for="supplier-name" class="form-label">Supplier Name *</label>
                <input type="text" class="form-control" id="supplier-name" required>
            </div>
            <div class="col-md-3">
                <label for="supplier-contact" class="form-label">Contact Person</label>
                <input type="text" class="form-control" id="supplier-contact">
            </div>
            <div class="col-md-3">
                <label for="supplier-phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="supplier-phone">
            </div>
            <div class="col-md-3">
                <label for="supplier-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="supplier-email">
            </div>
            <div class="col-12">
                <label for="supplier-address" class="form-label">Address</label>
                <textarea class="form-control" id="supplier-address" rows="1"></textarea>
            </div>
            <div class="col-12 d-flex justify-content-between">
                <button type="submit" class="btn btn-primary" id="submit-supplier-btn">Add Supplier</button>
                <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display:none;">Cancel Edit</button> 
            </div>
        </form>

        <hr>

        <h5>Current Suppliers</h5>
        <table id="suppliers-table" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Contact Person</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Action</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<div class="card">
    <h3>Purchase Orders</h3>
    <p>A place to create new purchase orders and manage received stock.</p>
    <a href="/purchases/new" class="btn btn-success mb-3">Create New Purchase Order</a>

    <table id="purchases-table" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>PO ID</th>
                <th>Supplier</th>
                <th>Date</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="po-list-body">
            <tr><td colspan="6" class="text-center">Loading Purchase Orders...</td></tr>
        </tbody>
    </table>
</div>

<script>
    let allSuppliers = [];
    
    document.addEventListener('DOMContentLoaded', () => {
        fetchSuppliers();
        setupSupplierForm();
        fetchPurchaseOrders();
        
        document.getElementById('cancel-edit-btn').addEventListener('click', resetSupplierForm); 
    });
    
    // --- UTILITY: Reset Form ---
    function resetSupplierForm() {
        document.getElementById('add-supplier-form').reset();
        document.getElementById('supplier-id-field').value = '';
        document.querySelector('.card-header h4').innerHTML = 'Add New Supplier <span id="supplier-id-display" class="badge bg-secondary ms-2" style="display:none;"></span>';
        document.getElementById('submit-supplier-btn').textContent = 'Add Supplier';
        document.getElementById('submit-supplier-btn').classList.remove('btn-warning');
        document.getElementById('submit-supplier-btn').classList.add('btn-primary');
        document.getElementById('cancel-edit-btn').style.display = 'none';
        document.getElementById('supplier-id-display').style.display = 'none';
    }
    
    // --- SUPPLIER LISTING/CRUD LOGIC (UNCHANGED) ---
    async function fetchSuppliers() {
        try {
            const response = await fetch('/api/purchases/suppliers');
            if (!response.ok) {
                console.error(`HTTP error! status: ${response.status}`, await response.text());
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const suppliers = await response.json();
            allSuppliers = suppliers;
            
            const tableBody = document.querySelector('#suppliers-table tbody');
            tableBody.innerHTML = ''; 

            if (suppliers.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `<td colspan="6" class="text-center">No suppliers added yet.</td>`;
                return;
            }

            suppliers.forEach(s => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.contact_person || '-'}</td>
                    <td>${s.phone || '-'}</td>
                    <td>${s.email || '-'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editSupplier(${s.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplier(${s.id})">Delete</button>
                    </td>
                `;
            });
        } catch (error) {
            console.error('Error fetching suppliers:', error);
            showNotification('Failed to load suppliers.', 'danger');
        }
    }

    function editSupplier(id) {
        const supplier = allSuppliers.find(s => s.id === id);
        if (!supplier) {
            showNotification('Error: Supplier details not found.', 'danger');
            return;
        }

        document.getElementById('supplier-id-field').value = supplier.id;
        document.querySelector('.card-header h4').innerHTML = `Edit Supplier (ID: ${supplier.id})`;
        document.getElementById('submit-supplier-btn').textContent = 'Update Supplier';
        document.getElementById('submit-supplier-btn').classList.remove('btn-primary');
        document.getElementById('submit-supplier-btn').classList.add('btn-warning');
        document.getElementById('cancel-edit-btn').style.display = 'inline-block';
        
        document.getElementById('supplier-name').value = supplier.name;
        document.getElementById('supplier-contact').value = supplier.contact_person || '';
        document.getElementById('supplier-phone').value = supplier.phone || '';
        document.getElementById('supplier-email').value = supplier.email || '';
        document.getElementById('supplier-address').value = supplier.address || '';
        
        document.getElementById('add-supplier-form').scrollIntoView({ behavior: 'smooth' });
    }

    async function deleteSupplier(id) {
        const supplierName = allSuppliers.find(s => s.id === id)?.name || `ID ${id}`;
        if (!confirm(`Are you sure you want to DELETE Supplier: ${supplierName}? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/purchases/suppliers/${id}`, {
                method: 'DELETE',
            });

            if (response.status === 204) {
                showNotification(`Supplier ${supplierName} deleted successfully.`, 'success');
                await fetchSuppliers();
            } else if (response.status === 404) {
                showNotification(`Error: Supplier ${supplierName} not found.`, 'danger');
            } else {
                const errorData = await response.json(); 
                showNotification(`Failed to delete supplier: ${errorData.detail || response.statusText}`, 'danger');
            }
        } catch (error) {
            console.error('Network error during deletion:', error);
            showNotification('Network error while attempting to delete supplier.', 'danger');
        }
    }
    
    function setupSupplierForm() {
        document.getElementById('add-supplier-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const supplierId = document.getElementById('supplier-id-field').value;
            const isEdit = !!supplierId;
            
            const actionVerb = isEdit ? 'Updated' : 'Added';
            const method = isEdit ? 'PUT' : 'POST';
            const url = isEdit ? `/api/purchases/suppliers/${supplierId}` : '/api/purchases/suppliers';
            
            const supplierData = {
                name: document.getElementById('supplier-name').value,
                contact_person: document.getElementById('supplier-contact').value,
                phone: document.getElementById('supplier-phone').value,
                email: document.getElementById('supplier-email').value,
                address: document.getElementById('supplier-address').value
            };

            const params = new URLSearchParams(supplierData).toString();

            try {
                const response = await fetch(`${url}?${params}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    showNotification(`Supplier ${actionVerb} Successfully!`, 'success');
                    resetSupplierForm();
                    await fetchSuppliers();
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.detail || `Failed to ${isEdit ? 'update' : 'add'} supplier.`;
                    showNotification(errorMessage, 'danger');
                }
            } catch (error) {
                console.error('Network error:', error);
                showNotification(`Network error while attempting to ${isEdit ? 'update' : 'add'} supplier.`, 'danger');
            }
        });
    }

    // =================================================================
    // PURCHASE ORDER LOGIC (FIXED RECEIVE AND ADDED DELETE)
    // =================================================================

    async function fetchPurchaseOrders() {
        const poTableBody = document.getElementById('po-list-body');
        poTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading Purchase Orders...</td></tr>'; 

        try {
            const response = await fetch('/api/purchases/'); 
            const orders = await response.json();

            poTableBody.innerHTML = '';

            if (orders.length === 0) {
                poTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No Purchase Orders found.</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = poTableBody.insertRow();
                
                let actionHtml;
                let statusClass;

                if (order.status === 'RECEIVED') {
                    // Received orders: only show a disabled status button
                    actionHtml = `<button class="btn btn-sm btn-success" disabled>Received</button>`;
                    statusClass = 'text-success fw-bold';
                } else {
                    // Pending orders: show Receive and Delete buttons
                    statusClass = 'text-warning fw-bold';
                    actionHtml = `
                        <button class="btn btn-sm btn-primary receive-btn me-2" data-po-id="${order.id}">Receive</button>
                        <button class="btn btn-sm btn-danger delete-po-btn" data-po-id="${order.id}">Delete</button>
                    `;
                }

                row.insertCell().textContent = order.id; 
                row.insertCell().textContent = order.supplier_name; 
                row.insertCell().textContent = order.date;
                row.insertCell().textContent = parseFloat(order.total_amount).toFixed(2);
                row.insertCell().innerHTML = `<span class="${statusClass}">${order.status}</span>`;
                row.insertCell().innerHTML = actionHtml;
            });

            // CRITICAL: Attach listeners to the dynamically created buttons
            attachPoButtonListeners(); 

        } catch (error) {
            console.error('Error fetching purchase orders:', error);
            showNotification('Failed to load Purchase Orders list.', 'danger');
            poTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load Purchase Orders.</td></tr>';
        }
    }

    function attachPoButtonListeners() {
        // 1. Receive Buttons
        document.querySelectorAll('.receive-btn').forEach(button => {
            button.addEventListener('click', function() {
                receivePurchase(this.dataset.poId);
            });
        });

        // 2. Delete Buttons
        document.querySelectorAll('.delete-po-btn').forEach(button => {
            button.addEventListener('click', function() {
                deletePurchase(this.dataset.poId);
            });
        });
    }

    async function receivePurchase(poId) {
        if (!confirm(`Are you sure you want to RECEIVE Purchase Order ID ${poId}? This action will update inventory.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/purchases/${poId}/receive`, {
                method: 'POST',
            });
            
            const data = await response.json();

            if (response.ok) {
                showNotification(data.message || `Purchase Order ${poId} received successfully!`, 'success');
                fetchPurchaseOrders();
            } else {
                // Handle 400 or 404 errors returned via HTTPException
                showNotification(data.detail || `Failed to receive PO ${poId}.`, 'danger');
            }
        } catch (error) {
            console.error('Error receiving purchase:', error);
            showNotification(`Network error while trying to receive PO ${poId}.`, 'danger');
        }
    }

    async function deletePurchase(poId) {
        if (!confirm(`WARNING: Are you sure you want to DELETE Purchase Order ID ${poId}? This action is permanent and only allowed if the PO is PENDING.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/purchases/${poId}`, {
                method: 'DELETE',
            });

            if (response.status === 204) {
                showNotification(`Purchase Order ${poId} deleted successfully.`, 'success');
                fetchPurchaseOrders();
            } else {
                const errorData = await response.json();
                showNotification(errorData.detail || `Failed to delete PO ${poId}.`, 'danger');
            }
        } catch (error) {
            console.error('Network error during deletion:', error);
            showNotification(`Network error while attempting to delete PO ${poId}.`, 'danger');
        }
    }


    // --- Dummy showNotification function ---
    function showNotification(message, type) {
        console.log(`[${type.toUpperCase()}] Notification: ${message}`);
        alert(`${type.toUpperCase()}: ${message}`);
    }
</script>
{% endblock %}